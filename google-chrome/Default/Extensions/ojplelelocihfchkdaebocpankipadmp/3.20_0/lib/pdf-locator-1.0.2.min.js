class LogHelper{static logDebug(e,t){LogHelper._isLoggingEnabled()&&(t?console.log(e,t):console.log(e))}static _isLoggingEnabled(){return"true"===sessionStorage.getItem("pdfLocatorLogging")}}function enablePdfLocatorLogging(){sessionStorage.setItem("pdfLocatorLogging","true")}class ConfigUtil{static getConfig(e){var t={doiBaseUrl:"http://dx.doi.org/"};return t.options={retryCount:Number.parseInt(e.options.retryCount)||2,connectionTimeout:Number.parseInt(e.options.connectionTimeout)||6e4,maxTotalConnections:Number.parseInt(e.options.maxTotalConnections)||15,maxConnectionsPerHost:Number.parseInt(e.options.maxConnectionsPerHost)||2},t}}class PDFLocatorUtil{static getDomainUrl(e,t=!0){var r="";return void 0!==e&&""!==e&&e.indexOf("://")>-1&&(r=e.split("/").slice(0,3).join("/")),t?r:r.split("//")[1]}static isAbsoluteUrl(e){return void 0!==e&&""!==e&&e.indexOf("://")>-1}static getAbsoluteUrl(e,t){return PDFLocatorUtil.isAbsoluteUrl(e)?e||"":"/"===e.trim()[0]?PDFLocatorUtil.getDomainUrl(t)+e:PDFLocatorUtil.getDomainUrl(t)+"/"+e}static getHTMLDoc(e){var t;try{t=(new DOMParser).parseFromString(e,"text/html")}catch(r){t=document.createElement("html"),r.innerHTML=e}return t}static endsWith(e,t){return!(!e||!t)&&e.toLowerCase().endsWith(t.toLowerCase())}static containsText(e,t){return!(!e||!t)&&e.toLowerCase().includes(t.toLowerCase())}}class HTTPRunner{static execute(e){HTTPRunner._http_retry(e,e.retryCount,1,e.timeout,e.success,e.error)}static _prepareHeaders(e,t){for(var[r,a]of Object.entries(t))e.setRequestHeader(r,a)}static _http_retry(e,t,r,a,n,o){var s=new XMLHttpRequest,i=e.method;s.open(i,e.url,!0),HTTPRunner._prepareHeaders(s,e.headers||{}),s.timeout=a,s.onreadystatechange=function(){if(4==s.readyState){var i={status:s.status,statusText:s.statusText,content:s.response,contentType:s.getResponseHeader("Content-Type"),headers:s.getAllResponseHeaders(),triedCount:r,responseURL:s.responseURL};if(200!==s.status)return 1===t?void o(i):HTTPRunner._http_retry(e,t-1,r+1,a,n,o);n(i)}},"GET"!==i&&"HEAD"!==i?s.send(e.body?JSON.stringify(e.body):""):s.send()}}class HTTPClient{static getContent(e,t,r){HTTPClient._httpRequest(t.url,t.options,"GET",function(a){var n={content:a.content,contentType:a.contentType,headers:a.headers,responseURL:a.responseURL,statusCode:a.status,method:"GET"};HTTPClient.sendResponse(e,t,n,r)})}static checkPdfDownload(e,t,r){HTTPClient._checkPdfDownloadRetry(e,t,t.options.httpMethods||["HEAD"],r)}static _checkPdfDownloadRetry(e,t,r,a){var n=r.shift();HTTPClient._httpRequest(t.url,t.options,n,function(o){!o.success&&r.length&&HTTPClient._checkPdfDownloadRetry(e,t,r,a);var s={content:"",contentType:o.contentType,headers:o.headers,responseURL:o.responseURL,statusCode:o.status,method:n};HTTPClient.sendResponse(e,t,s,a)})}static sendResponse(e,t,r,a){try{a===EntitlementChecker.name?EntitlementChecker.handleHttpClientResponse(e,t,r):a===ParsingStrategyManager.name?ParsingStrategyManager.handleHttpClientResponse(e,t,r):a===PDFLocator.name&&PDFLocator.handleHttpClientResponse(e,t,r)}catch(e){PDFLocator.dispatchErrorResponse(t,{},e.message)}}static _httpRequest(e,t,r,a){var n={},o={method:r=r||"GET",url:e,success:function(e){(n=e).success=!0,a(n)},error:function(e){(n=e).success=!1,a(n)}};return t.retryCount&&(o.retryCount=t.retryCount),t.connectionTimeout&&(o.timeout=t.connectionTimeout),HTTPRunner.execute(o),n}}class BrowserClient{static submitDownload(e,t,r){chrome.downloads.download({url:t.url,filename:t.filename||null},function(a){a?BrowserClient._downloadSuccess(e,t,r,a):BrowserClient._downloadFailure(e,t,r,a)})}static _downloadSuccess(e,t,r,a){chrome.downloads.search({id:a},function(n){var o=n?n[0]:void 0;o?"interrupted"===o.state?BrowserClient._downloadFailure(e,t,r,a):BrowserClient._sendResponse(e,t,{content:"",contentType:o.mime,headers:{},responseURL:o.url,statusCode:200},r):BrowserClient._downloadFailure(e,t,r,a)})}static _downloadFailure(e,t,r){BrowserClient._sendResponse(e,t,{content:"",contentType:"",headers:{},responseURL:"",statusCode:400},r)}static _sendResponse(e,t,r,a){a===PDFLocator.name&&PDFLocator.handleBrowserClientResponse(e,t,r)}}class EntitlementChecker{static checkEntitlements(e,t){t.url?HTTPClient.checkPdfDownload(e,t,EntitlementChecker.name):EntitlementChecker.sendResponse(e,t,{status:"failure",errorMessage:"no_pdf_link"})}static handleHttpClientResponse(e,t,r){var a={pdfLink:t.url,redirectPdfLink:r.responseURL,parsingStrategy:t.parsingStrategy};if(200===r.statusCode&&r.contentType&&r.contentType.includes("application/pdf")||r.headers&&r.headers.includes(".pdf")?a.status="success":200===r.statusCode?(a.status="failure",a.errorMessage="wrong_content_type"):0===r.statusCode?(a.status="failure",a.errorMessage="request_timed_out"):(a.status="failure",a.errorMessage="publisher_url_error"),"failure"===a.status&&"doi_2_pdf"===t.parsingStrategy&&(200===r.statusCode||r.responseURL.includes("aps.org/accepted")))return ParsingStrategyManager.getPdfUrl(e,t);a.publisherResponseCode=r.statusCode,t.creativeLicense&&(a.creativeLicense=t.creativeLicense),t.publisherHTML&&(a.publisherHTML=t.publisherHTML),EntitlementChecker.sendResponse(e,t,a)}static sendResponse(e,t,r){PDFLocator.processRequestActions(e,t,r)}}class Doi2PdfManager{static getPdfUrl(e,t){var r=t.data.articleMetadata.doi,a=DOIPrefixRulesetHelper.getPdfUrl(r),n=DOIPrefixRulesetHelper.getPreferredHttpMethods(r);a?(t.url=a,t.httpMethods=n,t.parsingStrategy="doi_2_pdf",EntitlementChecker.checkEntitlements(e,t)):ParsingStrategyManager.getPdfUrl(e,t)}}const DOI2PDF_RULE_SET={10.1002:"https://onlinelibrary.wiley.com/doi/pdf/{doi}",10.1007:"https://link.springer.com/content/pdf/{doi}.pdf",10.1021:"http://pubs.acs.org/doi/pdf/{doi}",10.1023:"https://link.springer.com/content/pdf/{doi}.pdf",10.1057:"https://link.springer.com/content/pdf/{doi}.pdf",10.1061:"https://ascelibrary.org/doi/pdf/{doi}",10.1063:"https://aip.scitation.org/doi/pdf/{doi}","10.1080":"http://www.tandfonline.com/doi/pdf/{doi}?needAccess=true",10.1088:"https://iopscience.iop.org/article/{doi}/pdf",10.1098:"https://royalsocietypublishing.org/doi/pdf/{doi}",10.1103:"http://link.aps.org/accepted/{doi}",10.1108:"http://www.emeraldinsight.com/doi/pdfplus/{doi}",10.1111:"https://onlinelibrary.wiley.com/doi/pdf/{doi}",10.1134:"https://link.springer.com/content/pdf/{doi}.pdf",10.1177:"http://journals.sagepub.com/doi/pdf/{doi}",10.1371:"http://journals.plos.org/ploscompbiol/article/file?id={doi}&type=printable"};class DOIPrefixRulesetHelper{static getRules(){return DOI2PDF_RULE_SET}static getHttpMethodsForPrefix(){return{}}static getPdfUrl(e){var t=DOIPrefixRulesetHelper.getRules(),r=e.split("/")[0],a="";return t.hasOwnProperty(r)&&(a=(a=t[r]).replace("{doi}",e)),a}static getPreferredHttpMethods(e){var t=DOIPrefixRulesetHelper.getHttpMethodsForPrefix(),r=e.split("/")[0],a=[];return t&&t.hasOwnProperty(r)&&(a=t[r]),a}}class ParsingStrategyManager{static getPdfUrl(e,t){t.data.articleMetadata.doi?t.url=e.doiBaseUrl+t.data.articleMetadata.doi:t.url=t.data.articleMetadata.fullTextURL,t.isPublisherPage=!0,HTTPClient.getContent(e,t,ParsingStrategyManager.name)}static handleHttpClientResponse(e,t,r){if(200===r.statusCode)if(t.isPublisherPage&&r.contentType&&r.contentType.includes("application/pdf"))t.parsingStrategy="direct_download",EntitlementChecker.handleHttpClientResponse(e,t,r);else{var a=PDFLocatorUtil.getHTMLDoc(r.content);ParsingStrategyManager._checkInterimPage(e,t,r,a)||(t.creativeLicense=ParsingStrategyManager._getCreativeLicense(a),ParsingStrategyManager._applyStrategies(e,t,r,a))}else EntitlementChecker.handleHttpClientResponse(e,t,r)}static _applyStrategies(e,t,r,a){var n="",o="NA",s=!1;(n=MetaTagHelper.getPdfUrl(a))&&(o="meta_tag",s=!0),s||(n=AdHocRuleHelper.getPdfUrl(r,a))&&(o="adhoc_rule",s=!0),s||(n=MLHelper.getPdfUrl(t,r,a))&&(o="ml_algorithm",s=!0),t.url=n,t.parsingStrategy=o,t.data.options.publisherHTML&&(t.publisherHTML=r.content),EntitlementChecker.checkEntitlements(e,t)}static _checkInterimPage(e,t,r,a){var n=PDFLocatorUtil.getDomainUrl(r.responseURL)||"",o=!1;if(n.includes("linkinghub.elsevier.com")||n.includes("ieee.org")&&!t.url.includes(".jsp")){if(n.includes("linkinghub.elsevier.com"))t.url=decodeURIComponent(decodeURIComponent(a.querySelector("input[name=redirectURL]").getAttribute("value")||"")).split("?")[0]+"/pdfft?isDTMRedir=true";else if(n.includes("ieee.org")&&!r.responseURL.includes(".jsp")){var s,i=document.evaluate("//script[contains(text(), 'global.document.metadata')]",a,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;i&&(s=i.innerText.match(/"pdfUrl"[^:]*:[^"]*"([^"]+)"/)),t.url="https://ieeexplore.ieee.org"+decodeURIComponent(s[1]||"")}t.isPublisherPage=!0,o=!0,t.url&&HTTPClient.getContent(e,t,ParsingStrategyManager.name)}return o}static _getCreativeLicense(e){var t=e.querySelector('a[href*="creativecommons.org/licenses"]');return t?t.getAttribute("href"):""}}class MetaTagHelper{static getPdfUrl(e){var t,r=e.querySelector('meta[name="citation_pdf_url"]');return r&&(t=r.getAttribute("content")||""),t}}const DOMAINS_TO_PUBLISHERS={"journals.aps.org":"APS","ascelibrary.org":"ASCE","ieeexplore.ieee.org":"IEEE","www.igi-global.com":"IGIGlobal","www.nejm.org":"JournalOfMedicine","journals.sagepub.com":"Sage"},WILDCARD_DOMAINS_TO_PUBLISHERS=Object.keys(DOMAINS_TO_PUBLISHERS).filter(e=>e.includes("*")),ADHOC_RULES={AAAOS:e=>{var t=e.querySelector('meta[name="citation_full_html_url"]');return t?t.getAttribute("content")+".pdf":""},ACSPH:e=>{var t=e.querySelector(".publicationFormatList li:nth-child(2) a");return t?t.getAttribute("href"):""},AIP:e=>{var t=e.querySelector(".article-menu .download-pdf a");return t?t.getAttribute("href"):""},APS:e=>{var t=e.querySelector(".button.expand");return t?t.getAttribute("href"):""},ASCE:e=>{var t=e.querySelector(".icon-download");return t?t.getAttribute("href"):""},ClinicalKey:e=>{var t=e.querySelector('a[data-action="pdfDownload"]');return console.log("ClinicalKey adhoc rule used"+(t?t.getAttribute("href"):"")),t?t.getAttribute("href"):""},Emerald:e=>{var t=e.querySelector('a[href*="doi/pdf"]');return t?t.getAttribute("href"):""},Gruyter:e=>{var t=e.querySelector('meta[name="citation_pdf_url"]');return t?t.getAttribute("content"):""},IEEE:e=>{var t=e.querySelector('iframe[src^="https://ieeexplore.ieee.org"]');return t?t.getAttribute("src"):""},IGIGlobal:e=>{var t=e.querySelector('a[href*="pdf/"');return t?t.getAttribute("href"):""},JournalOfMedicine:e=>{var t=e.querySelector('a[href*="doi/pdf"]');return t?t.getAttribute("href"):""},NATURE:e=>{var t=e.querySelector('a[data-track-dest="link:PDF"]');return t?t.getAttribute("href"):""},Sage:e=>{var t=e.querySelector('a[href*="doi/pdf"]');return t?t.getAttribute("href"):""},ScienceDirect:e=>{var t=e.querySelector('a[href^="https://pdf.sciencedirectassets.com"]');return t?t.getAttribute("href"):""},SpringerPlus:e=>{var t=e.querySelector("#articlePdf");return t?t.getAttribute("href"):""},TaylorFrancis:e=>{var t=e.querySelector('a[href*="doi/pdf"]');return t?t.getAttribute("href"):""}};class AdHocRuleHelper{static getPdfUrl(e,t){var r=AdHocRuleHelper._determinePublisherName(e);return AdHocRuleHelper._applyAdHocRule(e,t,r)}static _determinePublisherName(e){var t=PDFLocatorUtil.getDomainUrl(e.responseURL,!1)||"",r=DOMAINS_TO_PUBLISHERS[t];if(t&&!r&&WILDCARD_DOMAINS_TO_PUBLISHERS)for(const e of WILDCARD_DOMAINS_TO_PUBLISHERS)if(t.includes(e.replace("*",""))){r=DOMAINS_TO_PUBLISHERS[e][t];break}return r||""}static _applyAdHocRule(e,t,r){var a=r?ADHOC_RULES[r](t):"";return a&&!PDFLocatorUtil.isAbsoluteUrl(a)&&(a=PDFLocatorUtil.getAbsoluteUrl(a,PDFLocatorUtil.getDomainUrl(e.responseURL))),a}}class MLClassifier{static predict(e){MLClassifier.validateParams(e);var t,r=0;return e.doiInContent<=.5?e.termPdfFoundInCss<=.5?e.termDownloadInContent<=.5?e.linktextPdf<=.5?(r=4,t=!1):e.linkEndWithPdfExt<=.5?(r=5,t=!1):e.termTermsFormInContent<=.5?(r=6,t=!0):(r=6,t=!1):(r=3,t=!0):(r=2,t=!0):e.termPdfInContent<=.5?e.linktextPdf<=.5?(r=3,t=!1):(r=3,t=!0):(r=2,t=!0),{result:t,rank:r}}static getFeatures(){return["termTermsFormInContent","doiInContent","termPdfFoundInCss","termPdfInContent","linkEndWithPdfExt","linktextPdf","termDownloadInContent"]}static validateParams(e){var t=MLClassifier.getFeatures();return t.forEach(function(t){if(!e.hasOwnProperty(t))throw Error("Feature "+t+" is missing in the input: "+e)}),t.length}}class MLHelper{static getPdfUrl(e,t,r){var a=MLHelper._getFeatures(e.data.articleMetadata.doi,r),n=MLHelper._predictLink(e,a);return n&&!PDFLocatorUtil.isAbsoluteUrl(n)&&(n=PDFLocatorUtil.getAbsoluteUrl(n,PDFLocatorUtil.getDomainUrl(t.responseURL)),e.data.articleMetadata.doi?LogHelper.logDebug("DOI: "+e.data.articleMetadata.doi+" -> ML absolute pdfLink --\x3e "+n):LogHelper.logDebug("FullTextURL: "+e.data.articleMetadata.fullTextURL+" -> ML absolute pdfLink --\x3e "+n)),n}static _getFeatures(e,t){var r,a=[];return t.querySelectorAll("a,link,form").forEach(t=>{r=MLHelper._extractFeatures(t,e),r=Object.assign({pdflink:t.getAttribute("href")||""},r),a.push(r)}),a}static _extractFeatures(e,t){var r=e.textContent;return{termPdfFoundInCss:MLHelper._numericBool(PDFLocatorUtil.containsText(e.getAttribute("class"),"pdf")),termDownloadInContent:MLHelper._numericBool(PDFLocatorUtil.containsText(e.getAttribute("href"),"download")),termPdfInContent:MLHelper._numericBool(PDFLocatorUtil.containsText(e.getAttribute("href"),"pdf")),termTermsFormInContent:MLHelper._numericBool(MLHelper._termsInTitleCandidate(["terms","form"],e.getAttribute("href"))),linktextPdf:MLHelper._numericBool(PDFLocatorUtil.containsText(r,"pdf")),linkEndWithPdfExt:MLHelper._numericBool(PDFLocatorUtil.endsWith(e.getAttribute("href"),"pdf")),doiInContent:MLHelper._numericBool(PDFLocatorUtil.containsText(e.getAttribute("href"),t))}}static _predictLink(e,t){var r=[],a="";t.forEach(function(e){var t=MLClassifier.predict(e);r.push({result:t.result,rank:t.rank,pdflink:e.pdflink})});var n=r.filter(e=>e.result).sort(function(e,t){return t.rank-e.rank});for(let e=0;e<n.length&&(!(a=(a=n[e].pdflink||"").trim())||a.startsWith("#"));e++);return e.data.articleMetadata.doi?(LogHelper.logDebug("DOI: "+e.data.articleMetadata.doi+" -> ML predicted links --\x3e ",n),LogHelper.logDebug("DOI: "+e.data.articleMetadata.doi+" -> ML determined link --\x3e "+a)):(LogHelper.logDebug("FullTextURL: "+e.data.articleMetadata.fullTextURL+" -> ML predicted links --\x3e ",n),LogHelper.logDebug("FullTextURL: "+e.data.articleMetadata.fullTextURL+" -> ML determined link --\x3e "+a)),a}static _termsInTitleCandidate(e,t){if(!t||void 0===e)return!1;var r=t.split("?")[0].split("/").reverse()[0];return e.some(function(e){return r.toLowerCase().indexOf(e)>-1})}static _numericBool(e){return e?1:0}}class PDFLocator{static locatePDF(e,t){var r={data:e.data,tabId:e.tabId,callback:t,extensionName:e.extensionName};try{var a=ConfigUtil.getConfig(r.data);r.options=a.options||{},PDFLocator._validateInput(r.data),r.data.articleMetadata.doi?Doi2PdfManager.getPdfUrl(a,r):ParsingStrategyManager.getPdfUrl(a,r)}catch(e){PDFLocator.dispatchErrorResponse(r,{},e.message)}}static processRequestActions(e,t,r){var a=!0;("GetPDF"===t.data.action&&"success"===r.status||"DownloadPDF"===t.data.action&&"success"===r.status)&&(t.url=r.pdfLink,r.redirectPdfLink&&r.redirectPdfLink!=r.pdfLink&&(t.url=r.redirectPdfLink),t.pdfLinkResponse=r,a=!1,"DownloadPDF"===t.data.action?(t.filename=t.data.options&&t.data.options.downloadFileName,BrowserClient.submitDownload(e,t,PDFLocator.name)):HTTPClient.getContent(e,t,PDFLocator.name)),a&&PDFLocator.dispatchResponse(t,r)}static dispatchResponse(e,t){var r,a={};a.id=e.data.id,a.action=e.data.action,r=t.redirectPdfLink?t.redirectPdfLink:"",a.pdfMetadata={url:t.pdfLink,redirectUrl:r,success:"success"===t.status},"GetPDF"===e.data.action&&(a.pdfMetadata.content=t.content||"",a.pdfMetadata.message=t.errorMessage||""),a.optionalData={},e.data.options&&e.data.options.loggingData&&(a.optionalData.loggingData={parsingStrategy:t.parsingStrategy,publisherResponseCode:t.publisherResponseCode,creativeLicense:t.creativeLicense||"",errorMessage:t.errorMessage||""}),e.data.options&&e.data.options.publisherHTML&&(a.optionalData.publisherHTML=t.publisherHTML),e.data.opaque&&(a.opaque=e.data.opaque),e.callback(a)}static dispatchErrorResponse(e,t,r){var a={};a.id=e.data.id,a.action=e.data.action,a.pdfMetadata={url:"",redirectUrl:"",success:!1,message:r},a.optionalData={},e.data.options&&e.data.options.loggingData&&(a.optionalData.loggingData={}),e.data.opaque&&(a.opaque=e.data.opaque),e.callback(a)}static handleHttpClientResponse(e,t,r){200===(r=Object.assign(t.pdfLinkResponse||{},r)).statusCode?r.status="success":(r.status="failure",r.errorMessage="pdf_url_error"),PDFLocator.dispatchResponse(t,r)}static handleBrowserClientResponse(e,t,r){200===(r=Object.assign(t.pdfLinkResponse||{},r)).statusCode?r.status="success":(r.status="failure",r.errorMessage=r.downloadState),PDFLocator.dispatchResponse(t,r)}static _validateInput(e){if(!e||!e.articleMetadata)throw Error('Invalid input!. Input data is missing "articleMetadata".');if(!e.articleMetadata.doi&&!e.articleMetadata.fullTextURL)throw Error('Invalid input!. Either "doi" or "fullTextURL" is requred to process request.')}}try{module.exports={AdHocRuleHelper:AdHocRuleHelper,BrowserClient:BrowserClient,ConfigUtil:ConfigUtil,Doi2PdfManager:Doi2PdfManager,DOIPrefixRulesetHelper:DOIPrefixRulesetHelper,EntitlementChecker:EntitlementChecker,HTTPClient:HTTPClient,HTTPRunner:HTTPRunner,LogHelper:LogHelper,MetaTagHelper:MetaTagHelper,MLClassifier:MLClassifier,MLHelper:MLHelper,ParsingStrategyManager:ParsingStrategyManager,PDFLocator:PDFLocator,PDFLocatorUtil:PDFLocatorUtil}}catch(e){}